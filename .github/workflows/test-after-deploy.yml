name: Test After Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  wait-for-deploy:
    runs-on: ubuntu-latest
    outputs:
      backend_ready: ${{ steps.check-backend.outputs.ready }}
      frontend_ready: ${{ steps.check-frontend.outputs.ready }}
    steps:
      - name: Wait for Backend Deploy
        id: check-backend
        run: |
          SERVICE_ID="${{ secrets.RENDER_BACKEND_SERVICE }}"
          TOKEN="${{ secrets.RENDER_TOKEN }}"
          MAX_WAIT=600  # 10 minutes max
          INTERVAL=30   # Check every 30 seconds
          
          for ((i=0; i<MAX_WAIT; i+=INTERVAL)); do
            STATUS=$(curl -s -H "Authorization: Bearer $TOKEN" \
              "https://api.render.com/v1/services/$SERVICE_ID/deploys?limit=1" | \
              jq -r '.[0].deploy.status')
            
            echo "Backend status: $STATUS (waited ${i}s)"
            
            if [ "$STATUS" = "live" ]; then
              echo "ready=true" >> $GITHUB_OUTPUT
              exit 0
            elif [ "$STATUS" = "build_failed" ] || [ "$STATUS" = "update_failed" ]; then
              echo "ready=false" >> $GITHUB_OUTPUT
              echo "❌ Backend deploy failed"
              exit 1
            fi
            
            sleep $INTERVAL
          done
          
          echo "ready=false" >> $GITHUB_OUTPUT
          echo "❌ Backend deploy timeout"
          exit 1

      - name: Wait for Frontend Deploy
        id: check-frontend
        run: |
          SERVICE_ID="${{ secrets.RENDER_FRONTEND_SERVICE }}"
          TOKEN="${{ secrets.RENDER_TOKEN }}"
          MAX_WAIT=600
          INTERVAL=30
          
          for ((i=0; i<MAX_WAIT; i+=INTERVAL)); do
            STATUS=$(curl -s -H "Authorization: Bearer $TOKEN" \
              "https://api.render.com/v1/services/$SERVICE_ID/deploys?limit=1" | \
              jq -r '.[0].deploy.status')
            
            echo "Frontend status: $STATUS (waited ${i}s)"
            
            if [ "$STATUS" = "live" ]; then
              echo "ready=true" >> $GITHUB_OUTPUT
              exit 0
            elif [ "$STATUS" = "build_failed" ] || [ "$STATUS" = "update_failed" ]; then
              echo "ready=false" >> $GITHUB_OUTPUT
              echo "❌ Frontend deploy failed"
              exit 1
            fi
            
            sleep $INTERVAL
          done
          
          echo "ready=false" >> $GITHUB_OUTPUT
          echo "❌ Frontend deploy timeout"
          exit 1

  test-api:
    needs: wait-for-deploy
    if: ${{ needs.wait-for-deploy.outputs.backend_ready == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        working-directory: backend
        run: |
          pip install -r requirements.txt

      - name: Run API tests
        env:
          ENV: testing
          SECRET_KEY: test-secret-key-for-ci-and-local-123456
          DATABASE_URL: sqlite+aiosqlite:///./tests/test.db
          REDIS_URL: ""
          TEST_SECRET: test-secret-for-ci-only-2024
          TEST_TARGET_URL: https://tofubadminton-backend.onrender.com
        run: |
          cd backend
          PYTHONPATH=. ENV=testing pytest tests/ -v --tb=short 2>&1 | tee test-output.txt

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-results
          path: backend/test-output.txt

      - name: Create issue if tests fail
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('backend/test-output.txt', 'utf8');
            const errorLines = output.split('\n').filter(line => 
              line.includes('FAILED') || line.includes('Error') || line.includes('Traceback')
            ).slice(0, 20).join('\n');
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '❌ API Tests Failed',
              body: `## Test Failure Report

**Type:** API Test Failed
**Time:** ${new Date().toISOString()}
**Commit:** ${context.sha}

### Error Summary
\`\`\`
${errorLines}
\`\`\`

### Agent Instructions
1. Download and analyze full logs from artifacts
2. Fix the code in tofubadminton repo
3. Push the fix
4. Run: ./scripts/trigger-test.sh to re-run tests
5. Close this issue when fixed

[View Full Logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              labels: ['test-failed', 'auto-fix']
            });

  test-e2e:
    needs: [wait-for-deploy, test-api]
    if: ${{ needs.wait-for-deploy.outputs.frontend_ready == 'true' && needs.test-api.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: frontend
        run: npm install

      - name: Install Playwright
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Run E2E tests
        env:
          TEST_URL: https://tofubadminton.onrender.com
        run: |
          cd frontend
          npx playwright test --reporter=list,html 2>&1 | tee test-output.txt

      - name: Upload E2E results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            frontend/playwright-report/
            frontend/test-results/
            frontend/test-output.txt

      - name: Create issue if E2E fails
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '❌ E2E Tests Failed',
              body: `## E2E Test Failure Report

**Type:** E2E Test Failed
**Time:** ${new Date().toISOString()}
**Commit:** ${context.sha}

### Agent Instructions
1. Download screenshots and logs from artifacts
2. Analyze what failed (UI element not found, API error, etc.)
3. Fix in tofubadminton repo (backend or frontend)
4. Push the fix
5. Run: ./scripts/trigger-test.sh to re-run tests
6. Close this issue when fixed

[View Full Logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              labels: ['test-failed', 'auto-fix', 'e2e']
            });
